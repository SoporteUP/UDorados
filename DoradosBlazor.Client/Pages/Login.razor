@page "/"
@layout LoginLayout
@inject SesionEmail mySesionEmail;
@inject HttpClient httpClient
@using DoradosBlazor.Client.Extensiones
@using DoradosBlazor.Shared
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider autenticacionProvider
@inject NavigationManager navManager
@inject IJSRuntime JsRuntime
@using CurrieTechnologies.Razor.SweetAlert2;
@inject SweetAlertService Swal;
@using DoradosBlazor.Client.Pages

<div class="@loginBgClass">
    <div class="animated-lines">
        <span class="shooting-star blue" style="top: 12%; animation-delay: 0s; transform: rotate(18deg);"></span>
        <span class="shooting-star gold" style="top: 28%; animation-delay: 1.5s; transform: rotate(12deg);"></span>
        <span class="shooting-star blue" style="top: 39%; animation-delay: 3s; transform: rotate(24deg);"></span>
        <span class="shooting-star gold" style="top: 52%; animation-delay: 4.5s; transform: rotate(16deg);"></span>
        <span class="shooting-star blue" style="top: 64%; animation-delay: 6s; transform: rotate(10deg);"></span>
        <span class="shooting-star gold" style="top: 75%; animation-delay: 7.5s; transform: rotate(22deg);"></span>
        <span class="shooting-star blue" style="top: 83%; animation-delay: 9s; transform: rotate(14deg);"></span>
        <span class="shooting-star gold" style="top: 90%; animation-delay: 10.5s; transform: rotate(20deg);"></span>
    </div>

    <div class="superwow-login-card">
        <img src="UDNL.png" class="superwow-logo" alt="Logo" />
        <h2>¡Bienvenido!</h2>
        <p>Ingresa tus credenciales para continuar</p>

        <form @onsubmit="HandleFormSubmit">
            <div class="superwow-input">
                <i class="bi bi-envelope-fill"></i>
                <input @bind="login.Correo" placeholder="Correo electrónico" />
            </div>

            <div class="superwow-input">
                <i class="bi bi-lock-fill"></i>
                <input type="password" @bind="login.Password" placeholder="Contraseña" />
            </div>

            <button type="submit" class="superwow-btn">Ingresar</button>
        </form>

        <div class="superwow-footer">
            ¿No tienes cuenta? 
            <a role="button" @onclick="() => mostrarModalRegistro = true">Regístrate</a>
        </div>
    </div>
</div>

@if (mostrarModalRegistro)
{
    <Registro OnRegistroCompleto="OnRegistroCerrado" />
}

@code {
    private LoginDTO login = new LoginDTO();
    private bool mostrarModalRegistro = false;

    private string loginBgClass => mostrarModalRegistro ? "superwow-login-bg modal-activo" : "superwow-login-bg";

    private void OnRegistroCerrado()
    {
        mostrarModalRegistro = false;
    }

    private async Task HandleFormSubmit()
    {
        await IniciarSesion();
    }

    private async Task IniciarSesion()
    {
        var loginResponse = await httpClient.PostAsJsonAsync<LoginDTO>("/api/Usuario/Login", login);
        if (loginResponse.IsSuccessStatusCode)
        {
            var sesionUsuario = await loginResponse.Content.ReadFromJsonAsync<SesionDTO>();
            var autenticacionExt = (AutenticacionExtension)autenticacionProvider;
            await autenticacionExt.ActualizarEstadoAutenticacion(sesionUsuario);

            mySesionEmail.Email = login.Correo;
            navManager.NavigateTo($"/Index");
        }
        else
        {
            var resultado = await Swal.FireAsync(new SweetAlertOptions
                {
                    Title = "Datos incorrectos",
                    Text = "El usuario o la contraseña son incorrectos",
                    Icon = SweetAlertIcon.Error,
                    ShowCancelButton = true
                });
        }
    }

}
